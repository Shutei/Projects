import time
import tweepy
import json
from tweepy import Stream
from tweepy import OAuthHandler
from tweepy.streaming import StreamListener
import os

key = 'UpVz6YmeFjrbqQzeAejLreyhE'
secret = 'BrbTpN56hUiTLiboSM0uaaaRcqJSeauX1kSb82T07GXKxvYpMF'
token = '3315681727-nQcqrXQcSw7L1ym9o2sQrVzoA4dMCb1fSIQtD21'
token_secret = 'lZHzYpBCqfORGCvJAe0qU5mGpjw2HAQVhViEvTDvEX63b'
auth = tweepy.OAuthHandler(key, secret)
auth.set_access_token(token, token_secret)
api = tweepy.API(auth)

class StdOutListener(tweepy.StreamListener):
    def on_data(self, data):
        # Twitter returns data in JSON format - we need to decode it first
        decoded = json.loads(data)
        try:
            if not decoded['text'].startswith('RT') and not ": RT" in decoded['text'] and not "quoted_status_id" in decoded and not decoded['text'].startswith('@') and :
            # Also, we convert UTF-8 to ASCII ignoring all bad characters sent by users
                print '@%s: %s' % (decoded['user']['screen_name'], decoded['text'].encode('ascii', 'ignore'))
                print ''
                print decoded
                api.retweet(decoded['id'])
                api.create_friendship(decoded['entities']['user']['id'])
            return True
        except:
            print "unicode"

    def on_error(self, status):
        print status

if __name__ == '__main__':
    l = StdOutListener()
    auth = tweepy.OAuthHandler(key, secret)
    auth.set_access_token(token, token_secret)
    print "Showing all new tweets for retweet win:"

    # There are different kinds of streams: public stream, user stream, multi-user streams
    # In this example follow #programming tag
    # For more details refer to https://dev.twitter.com/docs/streaming-apis
    stream = tweepy.Stream(auth, l)
    stream.filter(track=['retweet win'])